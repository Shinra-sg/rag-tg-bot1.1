# Система разграничения доступа к документам

## Описание
Реализована система разграничения доступа к документам, позволяющая администраторам предоставлять доступ к конкретным документам только определенным пользователям по их username.

## Архитектура системы

### База данных
- **Таблица `document_access`**: Хранит информацию о доступе пользователей к документам
- **Представление `document_access_view`**: Удобное представление для просмотра доступа
- **Связи**: Связана с таблицами `documents` и `admins`

### Основные компоненты
1. **Админ бот**: Управление доступом к документам
2. **Основной бот**: Проверка доступа при поиске
3. **Утилиты**: Функции для работы с доступом

## Функциональность

### Для администраторов (Админ бот)

#### 1. Предоставление доступа
- Выбор документа из списка
- Ввод username пользователя
- Автоматическое создание записи доступа

#### 2. Отзыв доступа
- Выбор документа с предоставленным доступом
- Выбор пользователя из списка
- Деактивация доступа (мягкое удаление)

#### 3. Просмотр списка доступа
- Выбор документа
- Отображение всех пользователей с доступом
- Информация о том, кто и когда предоставил доступ

#### 4. Статистика доступа
- Общее количество документов
- Количество предоставленных доступов
- Уникальных пользователей с доступом
- Доступов за последние 7 дней

### Для пользователей (Основной бот)

#### 1. Проверка доступа
- Автоматическая проверка при каждом запросе
- Блокировка доступа если username не указан
- Блокировка доступа если нет разрешений

#### 2. Поиск с учетом доступа
- Векторный поиск только по доступным документам
- Fallback поиск с проверкой доступа
- Логирование заблокированных попыток доступа

## Установка и настройка

### 1. Создание таблиц
```bash
# Автоматическая настройка (рекомендуется)
./setup_access_permissions.sh

# Или ручная настройка:
psql -U shinra -d ragbot -f src/utils/create_document_access.sql
psql -U shinra -d ragbot -c "GRANT ALL PRIVILEGES ON TABLE document_access TO ragbot;"
psql -U shinra -d ragbot -c "GRANT ALL PRIVILEGES ON document_access_view TO ragbot;"
psql -U shinra -d ragbot -c "GRANT USAGE, SELECT ON SEQUENCE document_access_id_seq TO ragbot;"
psql -U shinra -d ragbot -c "GRANT ALL PRIVILEGES ON TABLE admins TO ragbot;"
psql -U shinra -d ragbot -c "GRANT USAGE, SELECT ON SEQUENCE admins_id_seq TO ragbot;"
```

### 2. Тестирование системы
```bash
npm run test:access
```

### 3. Запуск системы
```bash
npm run start:all:clean
```

## Использование

### Администратор

1. **Запустите админ бота**:
   ```bash
   npm run start:admin
   ```

2. **Перейдите в раздел "Управление доступом"**

3. **Предоставьте доступ**:
   - Выберите "Предоставить доступ"
   - Выберите документ из списка
   - Введите username пользователя (например: `@username` или `username`)

4. **Проверьте доступ**:
   - Выберите "Список доступа"
   - Выберите документ
   - Просмотрите список пользователей с доступом

### Пользователь

1. **Убедитесь, что у вас есть username в Telegram**

2. **Обратитесь к администратору для получения доступа**

3. **Используйте основной бот для поиска**:
   - Отправьте вопрос боту
   - Система автоматически проверит ваш доступ
   - Получите ответы только из доступных документов

## Технические детали

### Структура таблицы document_access
```sql
CREATE TABLE document_access (
    id SERIAL PRIMARY KEY,
    document_id INTEGER NOT NULL,
    username VARCHAR(255) NOT NULL,
    granted_by INTEGER NOT NULL,
    granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (document_id) REFERENCES documents(id) ON DELETE CASCADE,
    FOREIGN KEY (granted_by) REFERENCES admins(id) ON DELETE CASCADE,
    UNIQUE(document_id, username)
);
```

### Основные функции

#### `grantDocumentAccess(documentId, username, adminId)`
- Предоставляет доступ пользователю к документу
- Проверяет существование документа и админа
- Обрабатывает дублирование доступа

#### `revokeDocumentAccess(documentId, username)`
- Отзывает доступ пользователя к документу
- Мягкое удаление (установка is_active = FALSE)

#### `checkDocumentAccess(documentId, username)`
- Проверяет активный доступ пользователя к документу
- Возвращает boolean

#### `searchInstructionsWithAccess(query, username)`
- Векторный поиск с проверкой доступа
- Fallback на ILIKE поиск с проверкой доступа
- Фильтрация результатов по доступным документам

## Безопасность

### Принципы безопасности
1. **Принцип наименьших привилегий**: Пользователи видят только то, к чему у них есть доступ
2. **Аудит**: Все действия администраторов логируются
3. **Мягкое удаление**: Доступ отзывается, но запись сохраняется для аудита
4. **Проверка на уровне базы данных**: Все проверки доступа происходят в БД

### Логирование
- Все действия администраторов записываются в `admin_logs`
- Попытки доступа к заблокированным документам логируются
- Статистика доступа доступна администраторам

## Обратная совместимость

### Для пользователей без username
- Система работает в режиме обратной совместимости
- Используется обычный поиск без проверки доступа
- Рекомендуется всем пользователям указать username

### Для существующих документов
- Все существующие документы остаются доступными
- Новые документы требуют явного предоставления доступа
- Администраторы могут управлять доступом к любым документам

## Мониторинг и поддержка

### Команды для мониторинга
```bash
# Проверка состояния системы доступа
npm run test:access

# Просмотр статистики через админ бота
# Раздел "Управление доступом" -> "Статистика доступа"
```

### Устранение неполадок
1. **Пользователь не видит документы**: Проверьте, предоставлен ли ему доступ
2. **Ошибки в логах**: Проверьте целостность таблиц БД
3. **Проблемы с производительностью**: Проверьте индексы в БД

## Преимущества системы

- **Гибкость**: Точный контроль доступа к каждому документу
- **Безопасность**: Многоуровневая система проверок
- **Аудит**: Полное логирование всех действий
- **Простота**: Интуитивный интерфейс для администраторов
- **Масштабируемость**: Эффективная работа с большими объемами данных 